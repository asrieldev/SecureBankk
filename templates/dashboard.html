{% extends 'base.html' %}

{% block title %}Dashboard - SecureBank{% endblock %}

{% block content %}
<style>
/* --- Glass Card / Containers --- */
.glass { 
    background: rgba(255,255,255,0.6); 
    backdrop-filter: blur(15px); 
    border-radius:20px; 
    padding:20px; 
    color:#000; 
    margin-bottom:20px; 
}

/* --- KPI Tiles / Stats Cards --- */
.stats-card {
    background: rgba(255,255,255,0.7);
    padding: 15px;
    color: black;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    font-weight: 600;
    transition: transform 0.2s ease;
}
.stats-card:hover { transform: translateY(-3px); }
.stats-card h4 { font-size: 1.5rem; margin-bottom: 5px; }
.stats-card.success { background-color: rgba(198, 255, 203, 0.7); }
.stats-card.warning { background-color: rgba(255, 244, 179, 0.7); }
.stats-card.danger { background-color: rgba(255, 202, 202, 0.7); }

/* --- Bank / Account Card --- */
.account-card {
    background: linear-gradient(135deg,#2e8cff,#1c4fdc);
    color:#fff;
    border-radius:20px;
    padding:20px;
    margin-bottom:20px;
    position:relative;
}
.account-card h6 { font-weight:600; margin-bottom:5px; }
.account-card .account-number { font-size:0.9rem; margin-bottom:15px; }
.account-card h3 { font-size:1.5rem; }

/* --- User Details Tile --- */
.user-details-tile {
    background: rgba(0,0,0,0.05);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    text-align: center;
}
.user-details-tile h4 { font-size: 1.2rem; margin-bottom: 10px; }
.user-details-tile p { font-size: 1rem; }

/* --- Quick Action Cards --- */
.quick-action {
    background: rgba(255,255,255,0.7);
    border-radius:15px;
    padding:20px;
    text-align:center;
    transition: transform 0.2s ease;
}
.quick-action:hover { transform: translateY(-3px); }
.quick-action i { font-size:2rem; margin-bottom:10px; }

/* --- Table Styling --- */
.table-card table {
    width:100%;
    border-collapse: separate;
    border-spacing:0;
    font-size:0.85rem;
}
.table-card th, .table-card td { padding:8px 10px; text-align:left; }
.table-card th { background: rgba(0,0,0,0.05); border-bottom:1px solid rgba(0,0,0,0.1); font-weight:600; }
.table-card tbody tr:hover { background: rgba(0,0,0,0.05); }

/* Fraud Score Coloring */
.fraud-score.low { color:green; font-weight:600; }
.fraud-score.medium { color:orange; font-weight:600; }
.fraud-score.high { color:red; font-weight:600; }

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<div class="container-fluid">

  <!-- Greeting -->
  <h2 class="greeting-header mb-4">
       Welcome {{ current_user.first_name }}ðŸ‘‹ðŸ‘‹ðŸ˜Š
  </h2>


  <!-- Account Overview -->
  <div class="row mb-4">
    {% if accounts %}
        {% for account in accounts %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="account-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6>{{ account.account_type.title() }} Account</h6>
                        <div class="account-number">{{ account.account_number }}</div>
                    </div>
                    <span class="badge bg-primary">{{ account.account_type.upper() }}</span>
                </div>
                <h3>${{ "%.2f"|format(account.balance) }}</h3>
                <a href="{{ url_for('account_detail', account_id=account.id) }}" class="btn btn-outline-light btn-sm mt-3">
                    <i class="fas fa-eye me-1"></i>View Details
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="glass text-center p-4">
                <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                <h5>No accounts found</h5>
                <p class="text-muted">Contact your bank to set up your first account.</p>
            </div>
        </div>
    {% endif %}
  </div>
   <!-- User Details Tile -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="user-details-tile">
      <h4>User Details</h4>
      <p><strong>Name:</strong> {{ current_user.first_name }} {{ current_user.last_name }}</p>
      <p><strong>Username:</strong> {{ current_user.username }}</p>
      <p><strong>Email:</strong> {{ current_user.email }}</p>
      <p><strong>Phone Number:</strong> {{ current_user.phone }}</p>
      <p><strong>Account Type:</strong> 
        {% if current_user.accounts %}
          {% for account in current_user.accounts %}
            {{ account.account_type }} 
            <br />
          {% endfor %}
        {% else %}
          <span>No accounts available</span>
        {% endif %}
      </p>
      <p><strong>Account Number:</strong> 
        {% if current_user.accounts %}
          {% for account in current_user.accounts %}
            {{ account.account_number }} 
            <br />
          {% endfor %}
        {% else %}
          <span>No account number available</span>
        {% endif %}
      </p>
    </div>
  </div>
</div>


  
     <!-- Add a Link to Redirect to card.html -->
      <a href="{{ url_for('cards') }}" class="text-decoration-none"><i class="fas fa-credit-card me-2"></i> View Cards</a>


  <!-- Recent Transactions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="glass table-card">
        <h5 class="mb-3"><i class="fas fa-clock text-primary me-2"></i>Recent Transactions</h5>
        <div id="transactions-loader" class="text-center" style="display:none;">
          <div class="spinner"></div>
        </div>
        {% if transactions %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Fraud Score</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for transaction in transactions %}
                <tr class="{% if transaction.is_fraudulent %}table-danger{% endif %}">
                  <td>{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td><span class="badge bg-{% if transaction.transaction_type == 'transfer' %}primary{% elif transaction.transaction_type == 'deposit' %}success{% else %}warning{% endif %}">{{ transaction.transaction_type.title() }}</span></td>
                  <td>{{ transaction.description[:50] }}{% if transaction.description|length > 50 %}...{% endif %}</td>
                  <td class="{% if transaction.amount < 0 %}text-danger{% else %}text-success{% endif %}">${{ "%.2f"|format(transaction.amount) }}</td>
                  <td>
                    {% if transaction.fraud_score > 0 %}
                      <span class="fraud-score {% if transaction.fraud_score < 0.3 %}low{% elif transaction.fraud_score < 0.7 %}medium{% else %}high{% endif %}">{{ "%.1f"|format(transaction.fraud_score * 100) }}%</span>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                  </td>
                  <td>
                    {% if transaction.is_fraudulent %}
                      <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Fraudulent</span>
                    {% else %}
                      <span class="badge bg-success"><i class="fas fa-check me-1"></i>Safe</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5>No transactions yet</h5>
            <p class="text-muted">Your transaction history will appear here.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Fraud Detection Status -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="glass">
        <h5 class="mb-3"><i class="fas fa-shield-alt text-primary me-2"></i>Fraud Detection Status</h5>
        <div class="row text-center">
          <div class="col-md-3"><div class="stats-card p-3 rounded"><h4>{{ transactions|length }}</h4><p>Total Transactions</p></div></div>
          <div class="col-md-3"><div class="stats-card success p-3 rounded"><h4>{{ transactions|selectattr('is_fraudulent', 'equalto', false)|list|length }}</h4><p>Safe Transactions</p></div></div>
          <div class="col-md-3"><div class="stats-card warning p-3 rounded"><h4>{{ transactions|selectattr('is_fraudulent', 'equalto', true)|list|length }}</h4><p>Flagged Transactions</p></div></div>
          <div class="col-md-3"><div class="stats-card danger p-3 rounded"><h4>99.5%</h4><p>Detection Accuracy</p></div></div>
        </div>
      </div>
    </div>
  </div>

</div>
 <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="quick-action">
        <i class="fas fa-exchange-alt text-primary"></i>
        <h6>Transfer Money</h6>
        <a href="{{ url_for('transfer') }}" class="btn btn-primary btn-sm mt-2"><i class="fas fa-arrow-right me-1"></i>Transfer</a>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="quick-action">
        <i class="fas fa-history text-success"></i>
        <h6>Transaction History</h6>
        <button class="btn btn-success btn-sm mt-2" onclick="loadTransactions()"><i class="fas fa-list me-1"></i>View All</button>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="quick-action">
        <i class="fas fa-chart-line text-info"></i>
        <h6>Analytics</h6>
        <button class="btn btn-info btn-sm mt-2" onclick="showAnalytics()"><i class="fas fa-chart-bar me-1"></i>Analytics</button>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="quick-action">
        <i class="fas fa-shield-alt text-warning"></i>
        <h6>Security</h6>
        <button class="btn btn-warning btn-sm mt-2" onclick="showSecurity()"><i class="fas fa-lock me-1"></i>Security</button>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
function loadTransactions() {
    // Show the spinner while loading transactions
    document.getElementById('transactions-loader').style.display = 'block';

    fetch('/api/transactions')
        .then(response => response.json())
        .then(data => {
            console.log('Transactions loaded:', data);
            alert('Transactions loaded! Check console for details.');
            // Hide the spinner once loading is complete
            document.getElementById('transactions-loader').style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading transactions:', error);
            alert('An error occurred while loading transactions.');
            // Hide the spinner in case of error
            document.getElementById('transactions-loader').style.display = 'none';
        });
}

function showAnalytics() { alert('Analytics feature coming soon!'); }
function showSecurity() { alert('Security settings coming soon!'); }
</script>
{% endblock %}
